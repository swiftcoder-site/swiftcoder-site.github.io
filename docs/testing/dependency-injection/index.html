<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://swiftcoder.site/testing/dependency-injection/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Dependency injection - Swift Coder - Artur Gurgul</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "The app implementation", url: "#_top", children: [
          ]},
          {title: "Define dependency", url: "#define-dependency", children: [
          ]},
          {title: "Implementation of dependency injector", url: "#implementation-of-dependency-injector", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../design-patterns/creational-patterns/singleton/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../design-patterns/creational-patterns/singleton/" class="btn btn-xs btn-link">
        Singleton
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../.." class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../.." class="btn btn-xs btn-link">
        Home
      </a>
    </div>
    
  </div>

    

    <h3 id="the-app-implementation">The app implementation</h3>
<p>First, we need to create the interface for our reposiotry that provides us the temperature for given location.
In order to make the app more testable we will use the protocol defined below across the whole app instead of a class name that points to the final implementation.</p>
<pre><code class="language-swift">protocol TemperatureProviding {
    func temperature(for location: CLLocation, result: (Float64) -&gt; Void)
}
</code></pre>
<p><code>TemperatureProvider</code> is the class that implements the real api calls and operates on real data, but the app will not use it directly in order to have possibility to mock the data repository.</p>
<pre><code class="language-swift">protocol TemperatureProvider: LoggerProviding {
    func temperature(for location: CLLocation, result: (Float64) -&gt; Void)
        // requesting the temperature from backend or whatever 
    }
}
</code></pre>
<p>Every time when we want to use repository we need to inject it into the class using <code>@Injected</code> property wrapper. The point of it is that the <code>TemperatureProvider</code> user does not know the target implementation and not even care.  </p>
<pre><code class="language-swift">struct TemperatureViewModel {
    @Injected(\.temperatureProvider) var temperatureProvider: TemperatureProvider

    func loadData() {
        let location = CLLocation(latitude: 49.9683988, longitude: 20.7260966)
        temperatureProvider.temperature(for: location, result: { temperature in
            print(&quot;temperature is: \(temperature)&quot;)
        }
    }
}
</code></pre>
<h3 id="define-dependency">Define dependency</h3>
<p>1st step: Depencency injector uses <code>InjectionKey</code> to register depencencies. It stores in the static property a currenct value for every key type (see next chapter to see implementation)</p>
<p>Every class that is injected has to implement key and current value like this:</p>
<pre><code class="language-swift">private struct TemperatureProviderKey: InjectionKey {
    static var currentValue: TemperatureProviding = TemperatureProvider()
}
</code></pre>
<p>2nd step: Extend <code>InjectedValues</code> and add propetry to it. It will link the exact <code>InjectionKey</code> implementation with the property. The property wrapper called like this <code>@Injected(\.temperatureProvider)</code> will take the pey path, access <code>InjectedValues</code> and use keypath on it, and the getter of an injected propeperty will extract value from <code>InjectionKey</code>.</p>
<pre><code class="language-swift">extension InjectedValues {
    var temperatureProvider: TemperatureProviding {
        get { Self[TemperatureProviderKey.self] }
        set { Self[TemperatureProviderKey.self] = newValue }
    }
}
</code></pre>
<ul>
<li><code>InjectedValues[\.temperatureProvider] = MockedTemperatureProvider()</code></li>
</ul>
<h3 id="implementation-of-dependency-injector">Implementation of dependency injector</h3>
<p>Let's define the protocol that defines the <code>InjectionKey</code> that holds current value</p>
<pre><code class="language-swift">public protocol InjectionKey {
    associatedtype Value
    static var currentValue: Self.Value { get set }
}
</code></pre>
<p>Here is how <code>InjectedValues</code> is defined. </p>
<pre><code class="language-swift">struct InjectedValues {
    private static var current = InjectedValues()
    private init() {}

    static subscript&lt;K&gt;(key: K.Type) -&gt; K.Value where K : InjectionKey {
        get { key.currentValue }
        set { key.currentValue = newValue }
    }

    static subscript&lt;T&gt;(_ keyPath: WritableKeyPath&lt;InjectedValues, T&gt;) -&gt; T {
        get { current[keyPath: keyPath] }
        set { current[keyPath: keyPath] = newValue }
    }
}
</code></pre>
<p>and there is definition of the property wrapper</p>
<pre><code class="language-swift">@propertyWrapper
struct Injected&lt;T&gt; {
    private let keyPath: WritableKeyPath&lt;InjectedValues, T&gt;
    var wrappedValue: T {
        get { InjectedValues[keyPath] }
        set { InjectedValues[keyPath] = newValue }
    }

    init(_ keyPath: WritableKeyPath&lt;InjectedValues, T&gt;) {
        self.keyPath = keyPath
    }
}
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../design-patterns/creational-patterns/singleton/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../design-patterns/creational-patterns/singleton/" class="btn btn-xs btn-link">
        Singleton
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../.." class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../.." class="btn btn-xs btn-link">
        Home
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>